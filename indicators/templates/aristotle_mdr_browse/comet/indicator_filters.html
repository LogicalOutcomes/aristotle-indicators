{% load i18n aristotle_tags aristotle_help logicaltags %}

<div class="indicator-filters">
    <form id="indicator-filter-form" action="." method="get">

        <h3 class="indicator-filters_title">{% trans "Collections" %}</h3>

        {% for collection in collections %}
            <div class="checkbox">
                <label>
                    <input type="checkbox" name="collections" value="{{collection.value}}" {% if collection.value in selected_collections %}checked{% endif %}>
                    {{collection.value}} ({{collection.count}})
                </label>
            </div>
        {% endfor %}

    </form>
</div>

<script>
$(function(){
    // Filters
    var xhr,
        lastURL = '',
        overlay='<div class="loading-overlay"><h3 class="text-center"><i class="fa fa-spinner fa-spin fa-fw"></i> Loading</h3></div>';

    function updateFilters(e) {
        var params = $('#indicator-filter-form').serialize(),
            url = '.?'+params;

        if (lastURL !== url) {
            // prevent multiple calls
            if(xhr && xhr.readyState != 4){
                xhr.abort();
            }
            xhr = $.get(url, function(data) {
                var $data = $(data);
                $("#indicators-list-table").replaceWith($data.find("#indicators-list-table"));
            });
            $('#loading_indicator').remove();
            $('#indicators-list-table').html(overlay);
            // Update URL
            window.history.pushState('Browse indicators', 'Browse Indicators', url);
            lastURL = url;
        }
    };
    $('#indicator-filter-form input').on('change', updateFilters);

    window.onpopstate = function(event) {
        location.href = location.pathname + location.search
    };
});
</script>
