{% load i18n aristotle_tags aristotle_help logicaltags %}

<div class="indicator-filters">
    <h3 class="text-muted">{% trans "Refine by" %}</h3>

    <form id="indicator-filter-form" action="." method="get">


        {% include 'aristotle_mdr_browse/comet/_slot_filter.html' with name='Collections' param_name='col' selected_slots=col slots=collections %}

        <b class="indicator-filters_title">{% trans "Sustainable development goals" %}</b>

        {% for sdg in sdgs %}
            <div class="checkbox">
                <label>
                    <input type="checkbox" name="sdgs" value="{{sdg.short_name}}" {% if sdg.short_name in selected_sdgs %}checked{% endif %}>
                    {{sdg.short_name}} <span class="text-muted">({{sdg.count}})</span>
                </label>
            </div>

            {% if sdg.short_name == 'No poverty' %}
                {% include 'aristotle_mdr_browse/comet/_slot_filter.html' with name='No Poverty' param_name='no_pov' selected_slots=no_pov slots=no_poverty hide_title=True extra_classes='checkbox-inner' %}
            {% endif %}

        {% endfor %}


        {% include 'aristotle_mdr_browse/comet/_slot_filter.html' with name='Theory of change' param_name='toc' selected_slots=toc slots=theory_of_change %}

        {% include 'aristotle_mdr_browse/comet/_slot_filter.html' with name='Data collection method' param_name='dcm' selected_slots=dcm slots=data_collection_method %}
    </form>
</div>

<script>
$(function(){
    // Filters
    var xhr,
        lastURL = '',
        overlay='<div class="loading-overlay"><h3 class="text-center"><i class="fa fa-spinner fa-spin fa-fw"></i> Loading</h3></div>';

    function updateFilters(e) {
        var params = $('#indicator-filter-form').serialize(),
            url = '.?'+params;

        if (lastURL !== url) {
            // prevent multiple calls
            if(xhr && xhr.readyState != 4){
                xhr.abort();
            }
            xhr = $.get(url, function(data) {
                var $data = $(data);
                $("#indicators-list-table").replaceWith($data.find("#indicators-list-table"));
            });
            $('#loading_indicator').remove();
            $('#indicators-list-table').html(overlay);
            // Update URL
            window.history.pushState('Browse indicators', 'Browse Indicators', url);
            lastURL = url;
        }
    };
    $('#indicator-filter-form input').on('change', updateFilters);

    window.onpopstate = function(event) {
        location.href = location.pathname + location.search
    };
});
</script>
